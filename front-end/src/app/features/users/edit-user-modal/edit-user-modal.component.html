<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4"
     (click)="close.emit()">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col"
         (click)="$event.stopPropagation()">

        <div class="px-8 py-6 border-b border-gray-100 bg-white">
            <div class="flex justify-between items-start">
                <div class="space-y-1">
                    <h3 class="text-xl font-bold text-gray-900 tracking-tight">Editar Usuário</h3>
                </div>

                <button (click)="close.emit()"
                        class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-1 transition-all">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>



        <div class="p-8 space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <div class="space-y-4">

                    <div class="flex flex-col items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer relative" (click)="fileInput.click()">

                        <input #fileInput type="file" (change)="onFileSelected($event)" class="hidden" accept="image/*">

                        @if (previewUrl || editableUser.usua_foto) {
                            <img [src]="previewUrl || resolveImageUrl(editableUser.usua_foto)" class="w-24 h-24 rounded-full object-cover mb-2 border border-gray-200">
                            <span class="text-xs text-blue-600 font-semibold">Alterar foto</span>
                        } @else {
                            <div class="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center mb-2">
                                <i class="fa-solid fa-camera text-gray-400 text-2xl"></i>
                            </div>
                            <span class="text-xs text-gray-500">Clique para enviar foto</span>
                        }
                    </div>

                    <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-500 uppercase">Nome</label>
                        <input type="text" [(ngModel)]="editableUser.usua_nome" class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-sm">
                    </div>

                    <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-500 uppercase">E-mail</label>
                        <input type="email" [(ngModel)]="editableUser.usua_email" class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-sm">
                    </div>
                </div>

                <div class="space-y-4">

                    <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-500 uppercase">Código / Matrícula</label>
                        <input type="text" [(ngModel)]="editableUser.inst_usua_codigo" class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-sm">
                    </div>

                    <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-500 uppercase">CPF (Apenas números)</label>
                        <input type="text" [(ngModel)]="editableUser.usua_cpf" maxlength="11" class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-sm" placeholder="00000000000">
                    </div>

                    <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-500 uppercase">Data de Nascimento</label>
                        <input type="date" [(ngModel)]="editableUser.usua_data_nascimento" class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-sm">
                    </div>

                    <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-500 uppercase">Sexo</label>
                        <select [(ngModel)]="editableUser.usua_sexo" class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-sm">
                            <option [ngValue]="null">Selecione</option>
                            <option value="M">Masculino</option>
                            <option value="F">Feminino</option>
                        </select>
                    </div>

                    <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-500 uppercase">Função</label>
                        <select [(ngModel)]="editableUser.usuario_perfil" class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-sm">
                            <option value="Diretor">Diretor</option>
                            <option value="Professor">Professor</option>
                        </select>
                    </div>

                </div>
            </div>


            @if (editableUser.is_blacklisted === 1) {
                <div class="mt-6 pt-6 border-t border-dashed border-gray-200">
                    <div class="rounded-xl border border-red-100 bg-red-50 p-4 flex items-center justify-between group hover:border-red-200 transition-colors">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-red-500 shadow-sm border border-red-50">
                                <i class="fa-solid fa-user-lock text-lg"></i>
                            </div>
                            <div>
                                <p class="text-sm font-bold text-gray-900">Acesso Bloqueado</p>
                                <p class="text-xs text-red-600 font-medium mt-0.5">Usuário está na blacklist</p>
                            </div>
                        </div>

                        <ng-template #tipContent let-u>
                            <div class="flex flex-col items-center p-1 gap-1">
                                <span class="text-gray-200 font-medium">Liberação automática em:</span>
                                <app-countdown [deadline]="editableUser.blacklist_deadline!"></app-countdown>
                            </div>
                        </ng-template>

                        <button (click)="handleBlacklistClick()"
                                [disabled]="editableUser.can_be_removed === 0"
                                [appTooltip]="editableUser.can_be_removed === 0 ? tipContent : 'Liberar acesso agora'"
                                [class.opacity-50]="editableUser.can_be_removed === 0"
                                [class.grayscale]="editableUser.can_be_removed === 0"
                                class="px-4 py-2 bg-white border border-red-200 text-red-600 text-sm font-bold rounded-lg hover:bg-red-600 hover:text-white hover:border-red-600 hover:shadow-md disabled:hover:shadow-none disabled:hover:bg-white disabled:hover:text-red-600 transition-all duration-200">
                            Desbloquear
                        </button>
                    </div>
                </div>
            }
        </div>

        <div class="px-8 py-5 bg-gray-50/80 flex justify-end gap-3 border-t border-gray-100 backdrop-blur-sm">
            <button (click)="close.emit()"
                    class="px-5 py-2.5 text-sm font-bold text-gray-500 hover:text-gray-700 hover:bg-gray-200/50 rounded-lg transition-colors">
                Cancelar
            </button>
            <button (click)="save()"
                    class="px-6 py-2.5 bg-blue-600 text-white rounded-lg text-sm font-bold shadow-lg shadow-blue-600/20 hover:bg-blue-700 hover:shadow-blue-700/30 transform hover:-translate-y-0.5 transition-all duration-200">
                Salvar Alterações
            </button>
        </div>
    </div>
</div>

@if (showConfirm()) {
    <app-confirm-modal
            [title]="'Remover da Blacklist?'"
            (confirm)="executeRemoval()"
            (cancel)="showConfirm.set(false)">

        <p>
            Você está prestes a remover o usuário
            <span class="font-bold text-indigo-600 text-base">
            {{ editableUser.usua_nome }}
          </span>
            da lista de bloqueio. Esta ação permitirá que ele acesse o sistema imediatamente.
        </p>
    </app-confirm-modal>
}